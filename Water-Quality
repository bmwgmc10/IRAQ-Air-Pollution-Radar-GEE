/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = /* color: #98ff00 */ee.Geometry.Polygon(
        [[[43.50004094370231, 33.271810595744306],
          [43.532141621192544, 33.27669021398467],
          [43.52802174814567, 33.303810178441296],
          [43.4942044568859, 33.30007988972338]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// =================================================================
// Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ù…ÙŠØ§Ù‡ Ø§Ù„Ø£Ù†Ù‡Ø§Ø± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ
// =================================================================

// 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
var panel = ui.Panel({
  style: {width: '380px', padding: '15px', border: '2px solid #2c3e50'}
});

var title = ui.Label({
  value: 'ğŸ” Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø°ÙƒÙŠ',
  style: {fontSize: '20px', fontWeight: 'bold', color: '#2c3e50', textAlign: 'center', margin: '10px 0'}
});

// 2. Ø£Ø¯ÙˆØ§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©
var dateLabel = ui.Label('1. Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:', {fontWeight: 'bold'});
var dateSlider = ui.DateSlider({
  start: '2019-01-01',
  end: Date.now(),
  value: '2023-06-01',
  period: 1,
  style: {width: '95%'}
});

var toolLabel = ui.Label('2. Ø§Ø±Ø³Ù… Ù…Ø¶Ù„Ø¹Ø§Ù‹ ÙÙˆÙ‚ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ù‡Ø±:', {fontWeight: 'bold'});
var btnSelect = ui.Button({
  label: 'ğŸ“ ØªÙØ¹ÙŠÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„Ø±Ø³Ù…',
  onClick: function() {
    Map.drawingTools().setShape('polygon');
    Map.drawingTools().draw();
  },
  style: {width: '95%', color: 'blue'}
});

var btnClear = ui.Button({
  label: 'ğŸ—‘ï¸ Ù…Ø³Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø·Ù‚Ø©',
  onClick: function() {
    var layers = Map.drawingTools().layers();
    if (layers.length() > 0) {
      layers.get(0).geometries().clear();
      resultsPanel.clear();
      chartPanel.clear();
      Map.layers().reset();
    }
  },
  style: {width: '95%', color: 'red'}
});

// 3. Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
var resultsPanel = ui.Panel([ui.Label('Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...')]);
var chartPanel = ui.Panel();

panel.add(title)
     .add(dateLabel)
     .add(dateSlider)
     .add(toolLabel)
     .add(btnSelect)
     .add(btnClear)
     .add(ui.Label('---'))
     .add(resultsPanel)
     .add(chartPanel);

ui.root.insert(0, panel);

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function analyzeWater() {
  resultsPanel.clear();
  chartPanel.clear();
  resultsPanel.add(ui.Label('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ¶Ø§Ø¦ÙŠØ§Ù‹...', {color: 'gray'}));
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ø³ÙˆÙ…Ø©
  var drawingLayers = Map.drawingTools().layers();
  if (drawingLayers.length() === 0) return;
  var geometry = drawingLayers.get(0).getEeObject();
  
  // ØªØµØ­ÙŠØ­ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ù€ split
  var dateRange = dateSlider.getValue();
  var selectedDate = ee.Date(dateRange[0]); 
  
  // Ø¬Ù„Ø¨ ØµÙˆØ± Sentinel-2 (Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2A Ø§Ù„Ù…ØµØ­Ø­ Ø¬ÙˆÙŠØ§Ù‹)
  var collection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .filterBounds(geometry)
    .filterDate(selectedDate.advance(-6, 'month'), selectedDate.advance(6, 'month'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));

  var s2Image = collection.filterDate(selectedDate, selectedDate.advance(1, 'month')).first();

  if (!s2Image) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙˆØ§Ø¶Ø­Ø© (Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø­Ø¨) ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.'));
    return;
  }

  // Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± NDTI (Normalized Difference Turbidity Index)
  // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: (Red - Green) / (Red + Green)
  var ndti = s2Image.normalizedDifference(['B4', 'B3']).rename('NDTI');
  
  var stats = ndti.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: geometry,
    scale: 10
  });

  // 5. Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  stats.evaluate(function(result) {
    if (!result || result.NDTI === null) {
      resultsPanel.clear();
      resultsPanel.add(ui.Label('âš ï¸ Ø®Ø·Ø£: Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø©.'));
      return;
    }

    var val = result.NDTI.toFixed(3);
    var status = '';
    var color = '';
    var explanation = '';
    
    // ØªØµÙ†ÙŠÙ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ù„Ù…Ø¤Ø´Ø± NDTI
    if (val < -0.1) { 
      status = 'Ù…ÙŠØ§Ù‡ Ù†Ø¸ÙŠÙØ© Ø¬Ø¯Ø§Ù‹'; color = 'green'; 
      explanation = 'Ø§Ù„Ù…ÙŠØ§Ù‡ ØªØ¸Ù‡Ø± Ù†Ù‚Ø§Ø¡Ù‹ Ø¹Ø§Ù„ÙŠØ§Ù‹ ÙˆØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„ØµØ§Ù„Ø­Ø©.';
    }
    else if (val >= -0.1 && val < 0.05) { 
      status = 'Ø¬ÙˆØ¯Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©'; color = '#2ecc71'; 
      explanation = 'Ø¹ÙƒØ§Ø±Ø© Ù…Ù†Ø®ÙØ¶Ø©ØŒ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø£Ù†Ù‡Ø§Ø±.';
    }
    else if (val >= 0.05 && val < 0.2) { 
      status = 'ØªÙ„ÙˆØ« Ù…ØªÙˆØ³Ø· / Ø¹ÙƒØ§Ø±Ø©'; color = 'orange'; 
      explanation = 'ØªÙ†Ø¨ÙŠÙ‡: ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ø¹Ø§Ù„Ù‚Ø© Ø£Ùˆ Ø±ÙˆØ§Ø³Ø¨ Ø·ÙŠÙ†ÙŠØ© Ù‚Ø¯ ØªØ´ÙŠØ± Ù„ØªÙ„ÙˆØ« Ù…ÙˆØ¶Ø¹ÙŠ.';
    }
    else { 
      status = 'ØªÙ„ÙˆØ« Ø¹Ø§Ù„Ù Ø¬Ø¯Ø§Ù‹'; color = 'red'; 
      explanation = 'ØªØ­Ø°ÙŠØ±: Ø¹ÙƒØ§Ø±Ø© Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ø§Ù‹ ÙˆØ±ÙˆØ§Ø³Ø¨ ÙƒØ«ÙŠÙØ©ØŒ Ù„Ø§ ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØµØ­ÙŠØ©.';
    }

    resultsPanel.clear();
    resultsPanel.add(ui.Label('âœ… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ:', {fontWeight: 'bold', fontSize: '16px'}));
    resultsPanel.add(ui.Label('â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ' + selectedDate.format('yyyy-MM-dd').getInfo()));
    resultsPanel.add(ui.Label('â€¢ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹ÙƒØ§Ø±Ø© (NDTI): ' + val));
    resultsPanel.add(ui.Label('â€¢ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ' + status, {color: color, fontWeight: 'bold', fontSize: '14px'}));
    resultsPanel.add(ui.Label('ğŸ“ Ø§Ù„ØªÙØ³ÙŠØ±: ' + explanation, {fontSize: '12px', italic: true}));
  });

  // 6. Ø±Ø³Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø²Ù…Ù†ÙŠ (Chart)
  var timeSeriesChart = ui.Chart.image.seriesByRegion({
    imageCollection: collection.select(['B4'], ['Turbidity_Index']),
    regions: geometry,
    reducer: ee.Reducer.mean(),
    scale: 20,
    xProperty: 'system:time_start'
  }).setOptions({
    title: 'ØªØ°Ø¨Ø°Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù† (6 Ø£Ø´Ù‡Ø± Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ®)',
    vAxis: {title: 'Ø§Ù†Ø¹ÙƒØ§Ø³ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø­Ù…Ø± (Ù…Ø¤Ø´Ø± Ø¹ÙƒØ§Ø±Ø©)'},
    hAxis: {title: 'Ø§Ù„ØªØ§Ø±ÙŠØ®'},
    colors: ['#e67e22'],
    lineWidth: 2,
    pointSize: 4,
    trendlines: {0: {color: 'blue', lineWidth: 1, opacity: 0.3}}
  });

  chartPanel.add(timeSeriesChart);
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ØµØ±ÙŠ
  Map.layers().reset();
  Map.addLayer(s2Image, {bands:['B4','B3','B2'], max:3000}, 'ØµÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©');
  Map.centerObject(geometry, 14);
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø³Ù…
Map.drawingTools().onDraw(analyzeWater);

// ØªØ¬Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
Map.setOptions('SATELLITE');
Map.style().set('cursor', 'crosshair');