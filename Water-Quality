// =================================================================
// Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø© 100%
// =================================================================

// 1. Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù„ØºÙˆÙŠ
var dict = {
  'AR': {
    title: 'ðŸŒŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ù„ÙˆØ«Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡',
    dateEntry: 'Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD):',
    draw: 'ðŸ“ Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 
    clear: 'ðŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„', 
    run: 'â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„',
    langBtn: 'English',
    report: 'ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡:',
    turb: 'Ø§Ù„Ø¹ÙƒØ§Ø±Ø©', chl: 'Ø§Ù„ÙƒÙ„ÙˆØ±ÙˆÙÙŠÙ„', cdom: 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©',
    safe: 'Ø¢Ù…Ù†', warning: 'ØªÙ†Ø¨ÙŠÙ‡', danger: 'Ø®Ø·Ø±',
    noArea: 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© ÙÙˆÙ‚ Ø§Ù„Ù†Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹.'
  },
  'EN': {
    title: 'ðŸŒŠ Water Quality Monitoring',
    dateEntry: 'Enter Date (YYYY-MM-DD):',
    draw: 'ðŸ“ Draw Area', 
    clear: 'ðŸ—‘ï¸ Clear All', 
    run: 'â–¶ï¸ Run Analysis',
    langBtn: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    report: 'ðŸ“Š Water Quality Report (Water Only):',
    turb: 'Turbidity', chl: 'Chlorophyll', cdom: 'CDOM',
    safe: 'Safe', warning: 'Warning', danger: 'Danger',
    noArea: 'âš ï¸ Please draw an area over water first.'
  }
};

var currentLang = 'AR';

// 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
var panel = ui.Panel({style: {width: '360px', padding: '15px', border: '1px solid #ccc'}});
var titleLabel = ui.Label(dict[currentLang].title, {fontSize: '20px', fontWeight: 'bold', color: '#2980b9'});
var dateLabel = ui.Label(dict[currentLang].dateEntry);
var dateInput = ui.Textbox({value: '2026-01-01', style: {width: '150px'}});

var btnSelect = ui.Button(dict[currentLang].draw);
var btnClear = ui.Button(dict[currentLang].clear);
var btnRun = ui.Button(dict[currentLang].run);
var langBtn = ui.Button(dict[currentLang].langBtn);

var buttonPanel = ui.Panel([btnSelect, btnClear, btnRun, langBtn], ui.Panel.Layout.flow('horizontal'));
var resultsPanel = ui.Panel();
var chartPanel = ui.Panel();

panel.add(titleLabel).add(dateLabel).add(dateInput).add(buttonPanel).add(resultsPanel).add(chartPanel);
ui.root.insert(0, panel);

// 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© (ØªØµØ­ÙŠØ­ Ø§Ù„Ø®Ø·Ø£ 55)
Map.setCenter(44.36, 33.31, 6); // Ø§Ù„ØªÙ…Ø±ÙƒØ² ÙÙˆÙ‚ Ø§Ù„Ø¹Ø±Ø§Ù‚
Map.setControlVisibility({
  all: true,
  layerList: true,
  zoomControl: true,
  scaleControl: true,
  mapTypeControl: true,
  fullscreenControl: true
});

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£
Map.style().set('cursor', 'crosshair');
var drawingTools = Map.drawingTools();
drawingTools.setShown(true);

// 4. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ¹Ø²Ù„ Ø§Ù„ÙŠØ§Ø¨Ø³Ø© (Water Masking)
var processWater = function(img) {
  var t = img.get('system:time_start');
  
  // Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± NDWI Ù„Ø¹Ø²Ù„ Ø§Ù„ÙŠØ§Ø¨Ø³Ø©
  var ndwi = img.normalizedDifference(['B3', 'B8']).rename('NDWI');
  var waterMask = ndwi.gt(0.1); 
  
  var maskedImg = img.updateMask(waterMask);
  
  var turb = maskedImg.normalizedDifference(['B4', 'B3']).rename('Turbidity');
  var chl = maskedImg.normalizedDifference(['B5', 'B4']).rename('Chlorophyll');
  var cdom = maskedImg.select('B3').divide(maskedImg.select('B4')).rename('CDOM');
  
  return maskedImg.addBands([turb, chl, cdom]).set('system:time_start', t);
};

// 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ©
langBtn.onClick(function() {
  currentLang = (currentLang === 'AR' ? 'EN' : 'AR');
  titleLabel.setValue(dict[currentLang].title);
  dateLabel.setValue(dict[currentLang].dateEntry);
  btnSelect.setLabel(dict[currentLang].draw);
  btnClear.setLabel(dict[currentLang].clear);
  btnRun.setLabel(dict[currentLang].run);
  langBtn.setLabel(dict[currentLang].langBtn);
});

// 6. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø³Ù…
btnSelect.onClick(function() {
  drawingTools.setShape('polygon');
  drawingTools.draw();
});

btnClear.onClick(function() {
  drawingTools.layers().reset();
  resultsPanel.clear();
  chartPanel.clear();
  Map.layers().reset();
});

// 7. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function runAnalysis() {
  resultsPanel.clear();
  chartPanel.clear();
  
  var layers = drawingTools.layers();
  if (layers.length() === 0) {
    resultsPanel.add(ui.Label(dict[currentLang].noArea, {color: 'red'}));
    return;
  }
  
  var geometry = layers.get(0).getEeObject();
  var date = ee.Date(dateInput.getValue());

  var collection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .filterBounds(geometry)
    .filterDate(date.advance(-4, 'month'), date.advance(4, 'month'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 15));

  var s2 = collection.filterDate(date, date.advance(1, 'month')).first();
  if (!s2) {
    resultsPanel.add(ui.Label('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.', {color: 'red'}));
    return;
  }

  var finalImg = processWater(s2);
  
  finalImg.select(['Turbidity', 'Chlorophyll', 'CDOM']).reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: geometry,
    scale: 10
  }).evaluate(function(res) {
    if (!res || res.Turbidity === null) {
      resultsPanel.add(ui.Label('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙŠØ§Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¶Ù„Ø¹.', {color: 'orange'}));
      return;
    }
    
    resultsPanel.add(ui.Label(dict[currentLang].report, {fontWeight: 'bold'}));
    var show = function(val, labelKey) {
      var color = val > 0.05 ? 'red' : (val > 0.02 ? 'orange' : 'green');
      var status = val > 0.05 ? dict[currentLang].danger : (val > 0.02 ? dict[currentLang].warning : dict[currentLang].safe);
      resultsPanel.add(ui.Label('â€¢ ' + dict[currentLang][labelKey] + ': ' + val.toFixed(3) + ' [' + status + ']', {color: color}));
    };
    show(res.Turbidity, 'turb');
    show(res.Chlorophyll, 'chl');
    show(res.CDOM, 'cdom');
  });

  var chartCol = collection.map(processWater).select(['Turbidity', 'Chlorophyll', 'CDOM']);
  var chart = ui.Chart.image.series(chartCol, geometry, ee.Reducer.mean(), 30);
  chart.setOptions({
    title: 'Water Quality Trend',
    series: {0: {color: 'brown'}, 1: {color: 'green'}, 2: {color: 'blue'}}
  });
  chartPanel.add(chart);

  Map.layers().reset();
  Map.addLayer(s2, {bands:['B4','B3','B2'], max:3000}, 'Satellite View');
  Map.addLayer(finalImg.select('Turbidity'), {min: -0.05, max: 0.05, palette: ['blue', 'green', 'yellow', 'red']}, 'Turbidity Map');
}

btnRun.onClick(runAnalysis);