// =================================================================
// Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - Ù†Ø³Ø®Ø© Ø¹Ø²Ù„ Ø§Ù„ÙŠØ§Ø¨Ø³Ø© (Water Mask)
// =================================================================

// 1. Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù„ØºÙˆÙŠ
var dict = {
  'AR': {
    title: 'ğŸŒŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ù„ÙˆØ«Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡',
    dateEntry: 'Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (YYYY-MM-DD):',
    draw: 'ğŸ“ Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 
    clear: 'ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„', 
    run: 'â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„',
    langBtn: 'English',
    report: 'ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ (Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø§Ø¦ÙŠØ© ÙÙ‚Ø·):',
    turb: 'Ø§Ù„Ø¹ÙƒØ§Ø±Ø© (Turbidity)', 
    chl: 'Ø§Ù„ÙƒÙ„ÙˆØ±ÙˆÙÙŠÙ„ (Chlorophyll)', 
    cdom: 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© (CDOM)',
    safe: 'Ø¢Ù…Ù†', warning: 'ØªÙ†Ø¨ÙŠÙ‡', danger: 'Ø®Ø·Ø±',
    noArea: 'âš ï¸ ÙŠØ±Ø¬Ù‰ Ø±Ø³Ù… Ù…Ø¶Ù„Ø¹ ÙÙˆÙ‚ Ø§Ù„Ù…Ø³Ø·Ø­ Ø§Ù„Ù…Ø§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹.'
  },
  'EN': {
    title: 'ğŸŒŠ Water Quality Monitoring',
    dateEntry: 'Enter Date (YYYY-MM-DD):',
    draw: 'ğŸ“ Draw Area', 
    clear: 'ğŸ—‘ï¸ Clear All', 
    run: 'â–¶ï¸ Run Analysis',
    langBtn: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    report: 'ğŸ“Š Water Quality Report (Water Pixels Only):',
    turb: 'Turbidity', 
    chl: 'Chlorophyll', 
    cdom: 'CDOM',
    safe: 'Safe', warning: 'Warning', danger: 'Danger',
    noArea: 'âš ï¸ Please draw a polygon over water first.'
  }
};

var currentLang = 'AR';

// 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
var panel = ui.Panel({style: {width: '380px', padding: '15px', border: '1px solid #ccc'}});
var titleLabel = ui.Label(dict[currentLang].title, {fontSize: '20px', fontWeight: 'bold', color: '#2980b9'});
var dateLabel = ui.Label(dict[currentLang].dateEntry);
var dateInput = ui.Textbox({value: '2024-05-01', style: {width: '150px'}});

var btnSelect = ui.Button(dict[currentLang].draw);
var btnClear = ui.Button(dict[currentLang].clear);
var btnRun = ui.Button(dict[currentLang].run);
var langBtn = ui.Button(dict[currentLang].langBtn);

var buttonPanel = ui.Panel([btnSelect, btnClear, btnRun, langBtn], ui.Panel.Layout.flow('horizontal'));
var resultsPanel = ui.Panel();
var chartPanel = ui.Panel();

panel.add(titleLabel).add(dateLabel).add(dateInput).add(buttonPanel).add(resultsPanel).add(chartPanel);
ui.root.insert(0, panel);

// Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
Map.setControlVisibility({dateLayer: false});
var drawingTools = Map.drawingTools();
drawingTools.setShown(true);

// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ©
langBtn.onClick(function() {
  currentLang = (currentLang === 'AR' ? 'EN' : 'AR');
  titleLabel.setValue(dict[currentLang].title);
  dateLabel.setValue(dict[currentLang].dateEntry);
  btnSelect.setLabel(dict[currentLang].draw);
  btnClear.setLabel(dict[currentLang].clear);
  btnRun.setLabel(dict[currentLang].run);
  langBtn.setLabel(dict[currentLang].langBtn);
  resultsPanel.clear();
  chartPanel.clear();
});

btnSelect.onClick(function() {
  drawingTools.setShape('polygon');
  drawingTools.draw();
});

btnClear.onClick(function() {
  drawingTools.layers().reset();
  resultsPanel.clear();
  chartPanel.clear();
  Map.layers().reset();
});

// 4. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹ Ù‚Ù†Ø§Ø¹ Ø§Ù„Ù…ÙŠØ§Ù‡ (Water Mask)
var processImage = function(img) {
  var t = img.get('system:time_start');
  
  // Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙŠØ§Ù‡ NDWI Ù„Ø¹Ø²Ù„ Ø§Ù„ÙŠØ§Ø¨Ø³Ø©
  var ndwi = img.normalizedDifference(['B3', 'B8']).rename('NDWI');
  var waterMask = ndwi.gt(0.1); // Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù‚ÙŠÙ…ØªÙ‡Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 0.1 ØªØ¹ØªØ¨Ø± Ù…ÙŠØ§Ù‡
  
  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ù†Ø§Ø¹
  var maskedImg = img.updateMask(waterMask);
  
  var turb = maskedImg.normalizedDifference(['B4', 'B3']).rename('Turbidity');
  var chl = maskedImg.normalizedDifference(['B5', 'B4']).rename('Chlorophyll');
  var cdom = maskedImg.select('B3').divide(maskedImg.select('B4')).rename('CDOM');
  
  return maskedImg.addBands([turb, chl, cdom]).set('system:time_start', t);
};

// 5. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function analyze() {
  resultsPanel.clear();
  chartPanel.clear();
  
  var layers = drawingTools.layers();
  if (layers.length() === 0) {
    resultsPanel.add(ui.Label(dict[currentLang].noArea, {color: 'red'}));
    return;
  }
  
  var geometry = layers.get(0).getEeObject();
  var userDate = ee.Date(dateInput.getValue());

  var collection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .filterBounds(geometry)
    .filterDate(userDate.advance(-4, 'month'), userDate.advance(4, 'month'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20));

  var s2 = collection.filterDate(userDate, userDate.advance(1, 'month')).first();
  if (!s2) {
    resultsPanel.add(ui.Label('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.', {color: 'red'}));
    return;
  }

  var finalImg = processImage(s2);
  
  // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  var stats = finalImg.select(['Turbidity', 'Chlorophyll', 'CDOM']).reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: geometry,
    scale: 10,
    maxPixels: 1e9
  });

  stats.evaluate(function(res) {
    if (!res || res.Turbidity === null) {
      resultsPanel.add(ui.Label('âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙŠØ§Ù‡ ÙƒØ§ÙÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„.', {color: 'orange'}));
      return;
    }
    
    resultsPanel.add(ui.Label(dict[currentLang].report, {fontWeight: 'bold', fontSize: '15px'}));
    
    var showMetric = function(val, labelKey) {
      var color = val > 0.05 ? 'red' : (val > 0.02 ? '#f39c12' : 'green');
      var status = val > 0.05 ? dict[currentLang].danger : (val > 0.02 ? dict[currentLang].warning : dict[currentLang].safe);
      resultsPanel.add(ui.Label('â€¢ ' + dict[currentLang][labelKey] + ': ' + val.toFixed(3) + ' [' + status + ']', {color: color, fontWeight: 'bold'}));
    };

    showMetric(res.Turbidity, 'turb');
    showMetric(res.Chlorophyll, 'chl');
    showMetric(res.CDOM, 'cdom');
  });

  // Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø³Ù„Ø³Ù„Ø© Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù…ÙŠØ§Ù‡ ÙÙ‚Ø·)
  var chartCol = collection.map(processImage).select(['Turbidity', 'Chlorophyll', 'CDOM']);
  var chart = ui.Chart.image.series(chartCol, geometry, ee.Reducer.mean(), 30);
  chart.setOptions({
    title: 'Water Quality Trend',
    vAxis: {title: 'Value'},
    hAxis: {title: 'Date'},
    series: {0: {color: 'brown'}, 1: {color: 'green'}, 2: {color: 'blue'}}
  });
  chartPanel.add(chart);

  Map.layers().reset();
  Map.addLayer(s2, {bands:['B4','B3','B2'], max:3000}, 'Satellite View');
  Map.addLayer(finalImg.select('Turbidity'), {min: -0.1, max: 0.1, palette: ['blue', 'green', 'yellow', 'red']}, 'Turbidity Map');
}

btnRun.onClick(analyze);