// 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ğŸŒ
// Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù…Ù„Ù Ø§Ù„Ø´ÙŠØ¨ ÙØ§ÙŠÙ„ Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©
var studyAreaPath = 'projects/moh-proj/assets/Najaf-shp';
var geometry = ee.FeatureCollection(studyAreaPath);

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø³Ù†ÙˆØ§Øª ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„Ø´Ù‡ÙˆØ±
var START_YEAR = 2016; // Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† 2015 (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆÙØ±Ø© Ù…Ù† Ù…Ù†ØªØµÙ Ø§Ù„Ø¹Ø§Ù…)
var END_YEAR = 2016;
var START_MONTH = 12; 
var END_MONTH = 12;

// Ø§Ø³Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© ØµÙˆØ± Sentinel-2 L2A (Surface Reflectance)
var S2_COLLECTION = 'COPERNICUS/S2_SR'; 

// 2. Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª (NDVI Ùˆ NDWI) ğŸ“
/**
 * ØªØ­Ø³Ø¨ Ù…Ø¤Ø´Ø±ÙŠ NDVI Ùˆ NDWI ÙˆØªØ¶ÙŠÙÙ‡Ù…Ø§ ÙƒØ·Ø¨Ù‚Ø§Øª Ù„Ù„ØµÙˆØ±Ø©.
 */
var addIndices = function(image) {
  // Ø­Ø³Ø§Ø¨ NDVI: (NIR - Red) -> (B8 - B4) / (B8 + B4)
  var ndvi = image.normalizedDifference(['B8', 'B4']).rename('NDVI');
  // Ø­Ø³Ø§Ø¨ NDWI: (Green - NIR) -> (B3 - B8) / (B3 + B8)
  var ndwi = image.normalizedDifference(['B3', 'B8']).rename('NDWI');

  // Ù†Ø®ØªØ§Ø± Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ‚Ø· Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (median)
  return ndvi.addBands(ndwi);
};

// 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ¬Ù…ÙŠØ¹ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ±Ø¯ÙŠ ğŸš€
var processAndExport = function(year, month) {
  year = ee.Number(year);
  month = ee.Number(month);
  
  var startDate = ee.Date.fromYMD(year, month, 1);
  var endDate = startDate.advance(1, 'month');

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
  var yearStr = year.format('%d');
  var monthStr = month.format('%02d');
  
  // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  var filteredCollection = ee.ImageCollection(S2_COLLECTION)
      .filterDate(startDate, endDate)
      .filterBounds(geometry)
      // Ù„Ø§ ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ cloudMaskS2 Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ
      .map(addIndices); // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù„ÙƒÙ„ ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©

  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ÙÙŠ ØµÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø© Ø´Ù‡Ø±ÙŠØ© (Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ‚Ø·)
  var monthlyComposite = filteredCollection.median().clip(geometry);

  // --- Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù…Ø¤Ø´Ø± NDVI ---
  var ndviImage = monthlyComposite.select('NDVI');
  var ndviFileName = ee.String('Najaf_NDVI_').cat(yearStr).cat('_').cat(monthStr);

  Export.image.toDrive({
    image: ndviImage,
    description: ndviFileName.getInfo(),
    folder: 'GEE_Najaf_Exports_NDVI', // Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù€ NDVI
    fileNamePrefix: ndviFileName.getInfo(),
    scale: 10,
    region: geometry.geometry(),
    maxPixels: 1e10 
  });

  // --- Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù…Ø¤Ø´Ø± NDWI ---
  var ndwiImage = monthlyComposite.select('NDWI');
  var ndwiFileName = ee.String('Najaf_NDWI_').cat(yearStr).cat('_').cat(monthStr);

  Export.image.toDrive({
    image: ndwiImage,
    description: ndwiFileName.getInfo(),
    folder: 'GEE_Najaf_Exports_NDWI', // Ù…Ø¬Ù„Ø¯ Ø®Ø§Øµ Ù„Ù€ NDWI
    fileNamePrefix: ndwiFileName.getInfo(),
    scale: 10,
    region: geometry.geometry(),
    maxPixels: 1e10 
  });
};


// 4. Ø­Ù„Ù‚Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± (Loop) Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ğŸ”
for (var year = START_YEAR; year <= END_YEAR; year++) {
  for (var month = START_MONTH; month <= END_MONTH; month++) {
    // ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø´Ù‡Ø± Ù…Ù† 1 Ø¥Ù„Ù‰ 6 ÙÙŠ 2015 Ø­ÙŠØ« Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Sentinel-2
    if (year === 2015 && month <= 6) {
        print('Skipping ' + year + '/' + month + ': Sentinel-2 data not available before July 2015.');
        continue;
    }
    processAndExport(year, month);
  }
}
print('âœ… ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… Ø§Ù„ØªØµØ¯ÙŠØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Run" ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Tasks Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. (Ø³ØªØ¬Ø¯ Ù…Ø¬Ù„Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯ÙŠÙ† ÙÙŠ Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ).');


// ---
// 5. Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙˆØ¹Ø±Ø¶ Ù…Ø«Ø§Ù„ Ø´Ù‡Ø±ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ ğŸ—ºï¸
// ---

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª
var ndviParams = {min: -0.2, max: 0.8, palette: ['ffffe5', 'f7fcb9', 'd9f0a3', 'addd8e', '78c679', '41ab5d', '238443', '005a32']};
var ndwiParams = {min: -0.5, max: 0.7, palette: ['d9d9d9', '9ecae1', '4292c6', '2171b5', '08519c', '08306b']};

// Ø¹Ø±Ø¶ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØªØ¸Ù„ÙŠÙ„Ù‡Ø§
Map.centerObject(geometry, 9);
Map.addLayer(geometry, {color: 'FF0000'}, 'Najaf Study Area Boundary');

// Ø¹Ø±Ø¶ Ù…Ø«Ø§Ù„ Ø´Ù‡Ø±ÙŠ (Ø£ØºØ³Ø·Ø³ 2016)
var exampleYear = 2016;
var exampleMonth = 8;
var exampleStart = ee.Date.fromYMD(exampleYear, exampleMonth, 1);
var exampleEnd = exampleStart.advance(1, 'month');

var exampleComposite = ee.ImageCollection(S2_COLLECTION)
    .filterDate(exampleStart, exampleEnd)
    .filterBounds(geometry)
    .map(addIndices)
    .median()
    .clip(geometry);

Map.addLayer(exampleComposite.select('NDVI'), ndviParams, 'Example NDVI (No Cloud Mask) ' + exampleYear + '/' + exampleMonth);
Map.addLayer(exampleComposite.select('NDWI'), ndwiParams, 'Example NDWI (No Cloud Mask) ' + exampleYear + '/' + exampleMonth);