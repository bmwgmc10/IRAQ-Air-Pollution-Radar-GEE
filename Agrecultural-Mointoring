/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var geometry = /* color: #d63000 */ee.Geometry.Polygon(
        [[[43.18746895721038, 33.477896305285014],
          [43.19442124297698, 33.473922898989905],
          [43.20107312133391, 33.480974674970305],
          [43.19463581969817, 33.484124521413925]]]),
    field = /* color: #ff0000 */ee.Geometry.MultiPoint(),
    field2 = /* color: #ff0000 */ee.Geometry.MultiPoint(),
    field3 = /* color: #ff0000 */ee.Geometry.MultiPoint(),
    field4 = /* color: #ff0000 */ee.Geometry.MultiPoint();
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/**
 * Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ù†Ø³Ø®Ø© Ø«Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ù„ØºØ© 2026
 */

// --- 1. Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù„ØºØ§Øª (Dictionary) ---
var dict = {
  'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': {
    title: 'ðŸŒ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ',
    step1: '1. ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:',
    draw: 'ðŸ“ Ø±Ø³Ù… Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„',
    clear: 'ðŸ—‘ï¸ Ù…Ø³Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†',
    step2: '2. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:',
    run: 'ðŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
    step3: '3. Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:',
    errorNoGeom: 'âš ï¸ ÙØ¶Ù„Ø§Ù‹ Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø¶Ù„Ø¹ Ø£ÙˆÙ„Ø§Ù‹!',
    loading: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„... â³',
    errorNoData: 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.',
    reportTitle: 'ðŸ“Š ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù‚Ù„:',
    ndvi: 'ØµØ­Ø© Ø§Ù„Ù†Ø¨Ø§Øª (NDVI)',
    ndwi: 'Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© (NDWI)',
    lst: 'Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (LST)',
    adviceTitle: 'ðŸ“ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª:',
    adviceGood: 'â€¢ ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­Ù‚Ù„: Ù†Ù…Ùˆ Ù…Ù…ØªØ§Ø² ÙˆØµØ­ÙŠ.\nâ€¢ Ø§Ù„ØªÙˆØµÙŠØ©: Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙŠ.',
    adviceBad: 'â€¢ ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­Ù‚Ù„: Ø§Ù„Ù†Ø¨Ø§Øª ÙŠØ¹Ø§Ù†ÙŠ Ù…Ù† Ø¶Ø¹Ù ÙÙŠ Ø§Ù„Ù†Ù…Ùˆ.\nâ€¢ Ø§Ù„ØªÙˆØµÙŠØ©: ØªØ¹Ø²ÙŠØ² Ø§Ù„ØªØ³Ù…ÙŠØ¯ ÙˆÙØ­Øµ Ø§Ù„Ø¢ÙØ§Øª.',
    adviceHeat: '\nâ€¢ ØªØ­Ø°ÙŠØ±: Ø¥Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ Ù…Ø±ØªÙØ¹ØŒ ÙŠÙØ¶Ù„ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±ÙŠ.',
    mapLayer: 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØµØ­Ø©'
  },
  'English': {
    title: 'ðŸŒ± Agricultural Control Dashboard',
    step1: '1. Define Study Area:',
    draw: 'ðŸ“ Draw Field Boundaries',
    clear: 'ðŸ—‘ï¸ Clear & Reset',
    step2: '2. Operations:',
    run: 'ðŸš€ Run Analysis & Report',
    step3: '3. Select Monitoring Date:',
    errorNoGeom: 'âš ï¸ Please draw a polygon first!',
    loading: 'Analyzing... â³',
    errorNoData: 'âŒ No enough data for this date.',
    reportTitle: 'ðŸ“Š Field Condition Report:',
    ndvi: 'Plant Health (NDVI)',
    ndwi: 'Soil Moisture (NDWI)',
    lst: 'Current Temp (LST)',
    adviceTitle: 'ðŸ“ Real-time Report & Advice:',
    adviceGood: 'â€¢ Status: Excellent & healthy growth.\nâ€¢ Advice: Maintain current irrigation.',
    adviceBad: 'â€¢ Status: Plant growth is weak.\nâ€¢ Advice: Boost fertilization & check for pests.',
    adviceHeat: '\nâ€¢ Warning: High heat stress, increase irrigation.',
    mapLayer: 'Health Map'
  }
};

var lang = 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

// --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
var mainPanel = ui.Panel({
  style: {width: '380px', padding: '12px', border: '2px solid #2e7d32'}
});

// Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
var langSelect = ui.Select({
  items: Object.keys(dict),
  value: lang,
  onChange: function(value) {
    lang = value;
    refreshUI();
  },
  style: {position: 'top-right'}
});

var titleLabel = ui.Label('', {fontSize: '20px', fontWeight: 'bold', color: '#2e7d32', margin: '0 0 10px 0'});
var step1Label = ui.Label('', {fontWeight: 'bold'});
var btnDraw = ui.Button('');
var btnClear = ui.Button('');
var step2Label = ui.Label('', {fontWeight: 'bold', margin: '10px 0 5px 0'});
var btnRun = ui.Button({style: {stretch: 'horizontal', fontWeight: 'bold', color: '#1b5e20'}});
var step3Label = ui.Label('', {fontWeight: 'bold', margin: '10px 0 0 0'});

// ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©
mainPanel.add(langSelect).add(titleLabel).add(step1Label);
mainPanel.add(ui.Panel([btnDraw, btnClear], ui.Panel.Layout.Flow('horizontal')));
mainPanel.add(step2Label).add(btnRun);

var resultsPanel = ui.Panel({
  style: {margin: '15px 0 0 0', backgroundColor: '#f8f9fa', border: '1px solid #ddd', padding: '10px', shown: false}
});
mainPanel.add(resultsPanel);

// --- 3. ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ (Refresh UI) ---
function refreshUI() {
  titleLabel.setValue(dict[lang].title);
  step1Label.setValue(dict[lang].step1);
  btnDraw.setLabel(dict[lang].draw);
  btnClear.setLabel(dict[lang].clear);
  step2Label.setValue(dict[lang].step2);
  btnRun.setLabel(dict[lang].run);
  step3Label.setValue(dict[lang].step3);
  if (resultsPanel.style().get('shown')) runFullAnalysis(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ø±ÙˆØ¶Ø©
}

// --- 4. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… ---
var drawingManager = Map.drawingTools();
drawingManager.setShown(false); 
var drawLayer = ui.Map.GeometryLayer({name: 'field', color: 'red'});
drawingManager.layers().add(drawLayer);

btnDraw.onClick(function() {
  drawingManager.setShape('polygon');
  drawingManager.draw();
});

btnClear.onClick(function() {
  var layers = drawingManager.layers();
  if (layers && layers.length() > 0) layers.get(0).geometries().reset();
  resultsPanel.clear();
  resultsPanel.style().set('shown', false);
  Map.layers().reset();
});

// --- 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ---
function getCombinedData(date, roi) {
  var d = ee.Date(date);
  var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterBounds(roi).filterDate(d.advance(-20, 'day'), d.advance(1, 'day'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30)).median();
  var ndvi = s2.normalizedDifference(['B8', 'B4']).rename('NDVI');
  var ndwi = s2.normalizedDifference(['B3', 'B8']).rename('NDWI');
  var l8 = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2")
    .filterBounds(roi).filterDate(d.advance(-45, 'day'), d.advance(1, 'day')).median();
  var lst = l8.select('ST_B10').multiply(0.00341802).add(149.0).subtract(273.15).rename('LST');
  return ee.Image.cat([ndvi, ndwi, lst]).clip(roi);
}

// --- 6. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
function runFullAnalysis() {
  var layers = drawingManager.layers();
  var geometries = (layers.length() > 0) ? layers.get(0).geometries() : null;
  
  if (!geometries || geometries.length() === 0) {
    resultsPanel.style().set('shown', true);
    resultsPanel.clear();
    resultsPanel.add(ui.Label(dict[lang].errorNoGeom, {color: 'red'}));
    return;
  }
  
  resultsPanel.style().set('shown', true);
  resultsPanel.clear();
  resultsPanel.add(ui.Label(dict[lang].loading, {color: '#666'}));
  
  var roi = ee.Geometry(geometries.get(0));
  var date = dateSlider.getValue()[0];
  var data = getCombinedData(date, roi);
  
  var stats = data.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: roi,
    scale: 30,
    maxPixels: 1e8
  });

  Map.centerObject(roi, 16);
  Map.layers().set(0, ui.Map.Layer(data.select('NDVI'), {min: 0, max: 0.8, palette: ['#ecebb4', '#87af49', '#1e5109']}, dict[lang].mapLayer));

  stats.evaluate(function(res) {
    resultsPanel.clear();
    if (!res || res.NDVI === null) {
      resultsPanel.add(ui.Label(dict[lang].errorNoData, {color: 'red'}));
      return;
    }

    resultsPanel.add(ui.Label(dict[lang].reportTitle, {fontWeight: 'bold', color: '#2e7d32'}));
    
    var createRow = function(n, v, u) {
      return ui.Panel([ui.Label(n + ':', {width: '180px', fontSize: '12px'}), ui.Label(v.toFixed(2) + ' ' + u, {fontWeight: 'bold', fontSize: '12px'})], ui.Panel.Layout.Flow('horizontal'));
    };
    resultsPanel.add(createRow(dict[lang].ndvi, res.NDVI, ''));
    resultsPanel.add(createRow(dict[lang].ndwi, res.NDWI, ''));
    resultsPanel.add(createRow(dict[lang].lst, res.LST, 'Â°C'));

    resultsPanel.add(ui.Label('________________________________', {color: '#ddd'}));
    resultsPanel.add(ui.Label(dict[lang].adviceTitle, {fontWeight: 'bold', margin: '10px 0 5px 0'}));
    
    var advice = (res.NDVI < 0.4) ? dict[lang].adviceBad : dict[lang].adviceGood;
    if (res.LST > 35) advice += dict[lang].adviceHeat;

    resultsPanel.add(ui.Label(advice, {fontSize: '12px', whiteSpace: 'pre', color: '#333', backgroundColor: '#fff', padding: '5px'}));
  });
}

// --- 7. Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
var dateSlider = ui.DateSlider({
  start: '2024-01-01', end: '2026-01-21', value: '2026-01-21'
});
mainPanel.add(step3Label).add(dateSlider);

btnRun.onClick(runFullAnalysis);

ui.root.insert(0, mainPanel);
Map.style().set('cursor', 'crosshair');
refreshUI(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©