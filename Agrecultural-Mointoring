/**
 * Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© 2026
 * Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© ØµØ­Ø© Ø§Ù„Ù†Ø¨Ø§Øª ÙˆØ§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
 */

// --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Panel) ---
var mainPanel = ui.Panel({
  style: {
    width: '380px', 
    padding: '12px', 
    border: '2px solid #2e7d32'
  }
});

var title = ui.Label('ğŸŒ± Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©', {
  fontSize: '22px', 
  fontWeight: 'bold', 
  color: '#2e7d32',
  margin: '0 0 10px 0'
});

var description = ui.Label('Ø£Ø¯Ø§Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ ØµØ­Ø© Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ ÙˆØ§Ù„Ø±Ø·ÙˆØ¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Sentinel-2.', {
  fontSize: '13px', 
  color: '#555'
});

mainPanel.add(title).add(description);

// --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
var ndviVis = {min: 0, max: 0.8, palette: ['#ecebb4', '#d1db7d', '#87af49', '#4f8323', '#1e5109']};
var ndwiVis = {min: -0.2, max: 0.5, palette: ['#f7fbff', '#deebf7', '#9ecae1', '#4292c6', '#084594']};
var currentLayer = 'NDVI'; 

// --- 3. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® ---
function getSatelliteData(date) {
  var selectedDate = ee.Date(date);
  var collection = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterBounds(Map.getCenter())
    .filterDate(selectedDate.advance(-15, 'day'), selectedDate.advance(1, 'day'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
    .median();
    
  var ndvi = collection.normalizedDifference(['B8', 'B4']).rename('NDVI');
  var ndwi = collection.normalizedDifference(['B3', 'B8']).rename('NDWI');
  return collection.addBands([ndvi, ndwi]);
}

// --- 4. Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª ---
var dateLabel = ui.Label('1. Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:', {fontWeight: 'bold', margin: '15px 0 5px 0'});
var dateSlider = ui.DateSlider({
  start: '2024-01-01',
  end: '2026-01-17',
  value: '2026-01-17',
  period: 1,
  onChange: function() { updateDisplay(); }
});

var layerLabel = ui.Label('2. Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„:', {fontWeight: 'bold', margin: '15px 0 5px 0'});
var ndviBtn = ui.Button({label: 'ØµØ­Ø© Ø§Ù„Ù†Ø¨Ø§Øª (NDVI)', onClick: function() { currentLayer = 'NDVI'; updateDisplay(); }});
var ndwiBtn = ui.Button({label: 'Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù…Ø­ØµÙˆÙ„ (NDWI)', onClick: function() { currentLayer = 'NDWI'; updateDisplay(); }});

var btnPanel = ui.Panel([ndviBtn, ndwiBtn], ui.Panel.Layout.Flow('horizontal'));

mainPanel.add(dateLabel).add(dateSlider).add(layerLabel).add(btnPanel);

// --- 5. Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ ---
var tipsPanel = ui.Panel({
  style: {
    margin: '20px 0 0 0', 
    backgroundColor: '#f1f8e9', 
    padding: '10px', 
    border: '1px solid #c5e1a5'
  }
});
tipsPanel.add(ui.Label('ğŸ’¡ ÙƒÙŠÙ ØªÙ‚Ø±Ø£ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŸ', {fontWeight: 'bold', fontSize: '14px', color: '#33691e'}));
tipsPanel.add(ui.Label('â€¢ NDVI Ø§Ù„Ø¯Ø§ÙƒÙ†: Ù†Ø¨Ø§Øª ÙƒØ«ÙŠÙ ÙˆØµØ­ÙŠ Ø¬Ø¯Ø§Ù‹.', {fontSize: '11px'}));
tipsPanel.add(ui.Label('â€¢ NDWI Ø§Ù„Ø£Ø²Ø±Ù‚: ÙˆÙØ±Ø© Ù…Ø§Ø¦ÙŠØ©Ø› Ø§Ù†Ø®ÙØ§Ø¶Ù‡ ÙŠØ¹Ù†ÙŠ Ø­Ø§Ø¬Ø© Ù„Ù„Ø±ÙŠ.', {fontSize: '11px'}));
tipsPanel.add(ui.Label('â€¢ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ§Ø±ÙŠØ® Ù†Ù…ÙˆÙ‡Ø§.', {fontSize: '11px'}));
mainPanel.add(tipsPanel);

// --- 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ ---
var chartPanel = ui.Panel({style: {margin: '15px 0 0 0'}});
mainPanel.add(chartPanel);

Map.onClick(function(coords) {
  chartPanel.clear();
  var point = ee.Geometry.Point([coords.lon, coords.lat]);
  Map.layers().set(1, ui.Map.Layer(point, {color: 'red'}, 'Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©'));

  var chart = ui.Chart.image.series({
    imageCollection: ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
      .filterBounds(point)
      .filterDate('2025-01-01', '2026-01-17')
      .map(function(img) { return img.addBands(img.normalizedDifference(['B8', 'B4']).rename('NDVI')); }),
    region: point,
    reducer: ee.Reducer.mean(),
    scale: 10
  }).setOptions({
    title: 'ØªØ§Ø±ÙŠØ® Ù†Ù…Ùˆ Ø§Ù„Ù…Ø­ØµÙˆÙ„ (NDVI)',
    colors: ['#2e7d32'],
    hAxis: {title: 'Ø§Ù„ØªØ§Ø±ÙŠØ®'},
    vAxis: {title: 'Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù…Ùˆ'}
  });
  chartPanel.add(chart);
});

// --- 7. Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Legend) ---
var legend = ui.Panel({style: {position: 'bottom-left', padding: '8px'}});
Map.add(legend);

function updateLegend(title, palette, labels) {
  legend.clear();
  legend.add(ui.Label(title, {fontWeight: 'bold', fontSize: '14px'}));
  for (var i = 0; i < palette.length; i++) {
    var colorBox = ui.Label({style: {backgroundColor: palette[i], padding: '8px', margin: '0 0 4px 0'}});
    var description = ui.Label({value: labels[i] || '', style: {margin: '0 0 0 6px', fontSize: '11px'}});
    legend.add(ui.Panel([colorBox, description], ui.Panel.Layout.Flow('horizontal')));
  }
}

// --- 8. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ---
function updateDisplay() {
  var date = dateSlider.getValue()[0];
  var data = getSatelliteData(date);
  var activeImage = data.select(currentLayer);
  
  Map.layers().set(0, ui.Map.Layer(activeImage, 
    currentLayer === 'NDVI' ? ndviVis : ndwiVis, 
    currentLayer));
  
  if (currentLayer === 'NDVI') {
    updateLegend('ØµØ­Ø© Ø§Ù„Ù†Ø¨Ø§Øª (NDVI)', ndviVis.palette, ['Ø¶Ø¹ÙŠÙ', '', 'Ù…ØªÙˆØ³Ø·', '', 'Ù…Ù…ØªØ§Ø²']);
  } else {
    updateLegend('Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (NDWI)', ndwiVis.palette, ['Ø¬Ø§Ù', '', 'Ø±Ø·Ø¨', '', 'Ù…Ø´Ø¨Ø¹']);
  }
}

// Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
ui.root.insert(0, mainPanel);
Map.style().set('cursor', 'crosshair');
updateDisplay();