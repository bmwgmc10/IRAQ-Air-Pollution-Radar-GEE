/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var field = /* color: #ff0000 */ee.Geometry.Polygon(
        [[[48.808453378966455, 37.56951145079994],
          [48.970501718810205, 37.56080302204628],
          [48.98560791998208, 37.65001614325805],
          [48.866131601622705, 37.659801309994826]]]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
/**
 * Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© - Ù†Ø³Ø®Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù… (Tile Error)
 */

// --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
var mainPanel = ui.Panel({
  style: {width: '380px', padding: '12px', border: '2px solid #2e7d32'}
});

var title = ui.Label('ğŸŒ± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ', {
  fontSize: '20px', fontWeight: 'bold', color: '#2e7d32', margin: '0 0 10px 0'
});
mainPanel.add(title);

// --- 2. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ù…Ø³Ø­ ---
var drawingManager = Map.drawingTools();
drawingManager.setShown(false); 
var drawLayer = ui.Map.GeometryLayer({name: 'field', color: 'red'});
drawingManager.layers().add(drawLayer);

var btnDraw = ui.Button('ğŸ“ Ø±Ø³Ù… Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­Ù‚Ù„', function() {
  drawingManager.setShape('polygon');
  drawingManager.draw();
});

var btnClear = ui.Button('ğŸ—‘ï¸ Ù…Ø³Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†', function() {
  var layers = drawingManager.layers();
  if (layers.length() > 0) { layers.get(0).geometries().reset(); }
  resultsPanel.clear();
  resultsPanel.style().set('shown', false);
  Map.layers().reset();
});

mainPanel.add(ui.Label('1. ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:', {fontWeight: 'bold'}));
mainPanel.add(ui.Panel([btnDraw, btnClear], ui.Panel.Layout.Flow('horizontal')));

// --- 3. Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆÙ„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± ---
var resultsPanel = ui.Panel({
  style: {margin: '15px 0 0 0', backgroundColor: '#f8f9fa', border: '1px solid #ddd', padding: '10px', shown: false}
});

var btnRun = ui.Button({
  label: 'ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±',
  style: {stretch: 'horizontal', fontWeight: 'bold', color: '#1b5e20'},
  onClick: function() { runFullAnalysis(); }
});

mainPanel.add(ui.Label('2. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:', {fontWeight: 'bold', margin: '10px 0 5px 0'}));
mainPanel.add(btnRun).add(resultsPanel);

// --- 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³Ø±Ø¹Ø©) ---
function getCombinedData(date, roi) {
  var d = ee.Date(date);
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Sentinel-2 Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø®Ø¶Ø±ÙŠØ©
  var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterBounds(roi)
    .filterDate(d.advance(-20, 'day'), d.advance(1, 'day'))
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30))
    .median();
  
  var ndvi = s2.normalizedDifference(['B8', 'B4']).rename('NDVI');
  var ndwi = s2.normalizedDifference(['B3', 'B8']).rename('NDWI');

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Landsat Ù„Ù„Ø­Ø±Ø§Ø±Ø©
  var l8 = ee.ImageCollection("LANDSAT/LC08/C02/T1_L2")
    .filterBounds(roi)
    .filterDate(d.advance(-45, 'day'), d.advance(1, 'day'))
    .median();
  
  var lst = l8.select('ST_B10').multiply(0.00341802).add(149.0).subtract(273.15).rename('LST');
  
  // Ø¯Ù…Ø¬ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ÙˆÙ‚ØµÙ‡Ø§ Ù„Ø²ÙŠØ§Ø¯Ø© Ø³Ø±Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ…Ù†Ø¹ Tile Error
  return ee.Image.cat([ndvi, ndwi, lst]).clip(roi);
}

// --- 5. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ ---
function runFullAnalysis() {
  var geometries = drawLayer.geometries();
  if (geometries.length() === 0) {
    resultsPanel.style().set('shown', true);
    resultsPanel.clear();
    resultsPanel.add(ui.Label('âš ï¸ ÙØ¶Ù„Ø§Ù‹ Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø¶Ù„Ø¹ Ø£ÙˆÙ„Ø§Ù‹!', {color: 'red'}));
    return;
  }
  
  resultsPanel.style().set('shown', true);
  resultsPanel.clear();
  resultsPanel.add(ui.Label('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„... â³', {color: '#666'}));
  
  var roi = ee.Geometry(geometries.get(0));
  var date = dateSlider.getValue()[0];
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… try-catch ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ EEE Ù„Ø°Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  var data = getCombinedData(date, roi);
  
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø¨Ø¯Ù‚Ø© (Scale 30) Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  var stats = data.reduceRegion({
    reducer: ee.Reducer.mean(),
    geometry: roi,
    scale: 30, // ØªØºÙŠÙŠØ± Ø§Ù„Ù€ Scale Ø¥Ù„Ù‰ 30 ÙŠÙ…Ù†Ø¹ Ù…Ø¹Ø¸Ù… Ø£Ø®Ø·Ø§Ø¡ Tile Error
    maxPixels: 1e8
  });

  Map.centerObject(roi, 16);
  Map.layers().set(0, ui.Map.Layer(data.select('NDVI'), {min: 0, max: 0.8, palette: ['#ecebb4', '#87af49', '#1e5109']}, 'Ø®Ø±ÙŠØ·Ø© ØµØ­Ø© Ø§Ù„Ù…Ø­ØµÙˆÙ„'));

  stats.evaluate(function(res) {
    resultsPanel.clear();
    if (!res || res.NDVI === null || res.NDVI === undefined) {
      resultsPanel.add(ui.Label('âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®. Ø¬Ø±Ø¨ ØªØ§Ø±ÙŠØ®Ø§Ù‹ Ø¢Ø®Ø± Ø£Ùˆ ÙˆØ³Ø¹ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ù….', {color: 'red'}));
      return;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    resultsPanel.add(ui.Label('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø­Ù‚Ù„:', {fontWeight: 'bold', color: '#2e7d32'}));
    var createRow = function(n, v, u) {
      return ui.Panel([ui.Label(n + ':', {width: '150px', fontSize: '12px'}), ui.Label(v.toFixed(2) + ' ' + u, {fontWeight: 'bold', fontSize: '12px'})], ui.Panel.Layout.Flow('horizontal'));
    };
    resultsPanel.add(createRow('ØµØ­Ø© Ø§Ù„Ù†Ø¨Ø§Øª (NDVI)', res.NDVI, ''));
    resultsPanel.add(createRow('Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø© (NDWI)', res.NDWI, ''));
    resultsPanel.add(createRow('Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©', res.LST, 'Â°C'));

    // --- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„ÙˆØµØ§ÙŠØ§ ---
    resultsPanel.add(ui.Label('________________________________', {color: '#ddd'}));
    resultsPanel.add(ui.Label('ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:', {fontWeight: 'bold', margin: '10px 0 5px 0'}));
    
    var advice = "";
    if (res.NDVI < 0.35) {
      advice = "âš ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù†Ù…Ùˆ Ø§Ù„Ù†Ø¨Ø§Øª Ø¶Ø¹ÙŠÙ. \nğŸ’¡ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ø­Ù‚Ù„ Ù„ØªØ¹Ø²ÙŠØ² Ø§Ù„ØªØ³Ù…ÙŠØ¯ Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†ÙŠ ÙˆÙØ­Øµ Ø§Ù„ØªØ±Ø¨Ø© Ù…Ù† Ø§Ù„Ø¢ÙØ§Øª.";
    } else if (res.NDVI < 0.6) {
      advice = "âœ… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù†Ù…Ùˆ Ù…ØªÙˆØ³Ø· ÙˆÙ…Ø³ØªÙ‚Ø±. \nğŸ’¡ ÙŠÙØ¶Ù„ Ø±Ø´ Ø¹Ù†Ø§ØµØ± ØµØºØ±Ù‰ Ù„ØªØ­ÙÙŠØ² Ø§Ù„ÙƒÙ„ÙˆØ±ÙˆÙÙŠÙ„ ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬.";
    } else {
      advice = "ğŸŒŸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: Ù†Ù…Ùˆ Ù…Ù…ØªØ§Ø². \nğŸ’¡ Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±ÙŠ Ø¨Ø³Ø¨Ø¨ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±Ø©.";
    }
    
    if (res.LST > 38) {
      advice += "\n\nğŸ”¥ ØªØ­Ø°ÙŠØ± Ø­Ø±Ø§Ø±ÙŠ: Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ ØªÙƒØ«ÙŠÙ Ø§Ù„Ø±ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠ.";
    }

    resultsPanel.add(ui.Label(advice, {fontSize: '12px', whiteSpace: 'pre', color: '#333', backgroundColor: '#fff', padding: '5px'}));
  });
}

// --- 6. Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
var dateSlider = ui.DateSlider({
  start: '2024-01-01', end: '2026-01-21', value: '2026-01-21'
});
mainPanel.add(ui.Label('3. Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©:', {fontWeight: 'bold', margin: '10px 0 0 0'})).add(dateSlider);

ui.root.insert(0, mainPanel);
Map.style().set('cursor', 'crosshair');