// 1. استدعاء منطقة الدراسة من Assets الخاص بك
var khuzestan = ee.FeatureCollection("projects/moh-proj/assets/khuzestan-shp");

// 2. تحديد الفترة الزمنية
var start = '2015-01-01';
var end = '2025-12-31';

// 3. جلب بيانات السحب (سنستخدم هنا الإشعاع الشمسي كبديل دقيق لوفرة السحب كما اتفقنا)
// أو يمكنك استبداله بأي نطاق (Band) متاح في قائمتك السابقة
var climateData = ee.ImageCollection("ECMWF/ERA5_LAND/MONTHLY_AGGR")
            .filterBounds(khuzestan)
            .filterDate(start, end)
            .select('surface_net_solar_radiation_sum') // هذا المتغير يعكس وفرة السحب
            .mean()
            .clip(khuzestan);

// 4. إنشاء نقاط المحطات (بناءً على الإحداثيات التي استخدمناها في كولاب)
// ملاحظة: قمت بوضع أمثلة لـ 3 محطات، يمكنك إضافة بقية المحطات بنفس الطريقة
var stations = ee.FeatureCollection([
  ee.Feature(ee.Geometry.Point([48.33, 31.33]), {station_name: 'Ahvaz'}),
  ee.Feature(ee.Geometry.Point([48.23, 30.36]), {station_name: 'Abadan'}),
  ee.Feature(ee.Geometry.Point([48.29, 32.38]), {station_name: 'Dezful'}),
  ee.Feature(ee.Geometry.Point([49.41, 30.43]), {station_name: 'Mahshahr'})
]);

// 5. استخراج القيم من الخريطة إلى النقاط
var stationData = climateData.reduceRegions({
  collection: stations,
  reducer: ee.Reducer.mean(),
  scale: 1000
});

// 6. إضافة خطوط الطول والعرض لكل نقطة في الجدول الناتج
var finalTable = stationData.map(function(feature) {
  var coordinates = feature.geometry().coordinates();
  return feature.set({
    'Longitude': coordinates.get(0),
    'Latitude': coordinates.get(1),
    // تحويل القيمة المستخرجة لتعبر عن "وفرة السحب" (Average_Cloudiness)
    'Average_Cloudiness': feature.get('mean') 
  });
});

// 7. تصدير الجدول كملف CSV إلى Google Drive
Export.table.toDrive({
  collection: finalTable,
  description: 'Khuzestan_Stations_Cloud_Data',
  fileFormat: 'CSV',
  selectors: ['station_name', 'Longitude', 'Latitude', 'Average_Cloudiness'] // الأعمدة المطلوبة
});

// عرض المنطقة والمحطات للتأكد
Map.centerObject(khuzestan, 7);
Map.addLayer(khuzestan, {color: 'grey'}, 'Khuzestan Border');
Map.addLayer(stations, {color: 'red'}, 'Monitoring Stations');