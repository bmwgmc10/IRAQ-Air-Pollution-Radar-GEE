/**
 * Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªÙ„ÙˆØ« Ø§Ù„Ø´Ø§Ù…Ù„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù†Ù‚Ø­Ø© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø©
 * Ù…Ø®ØµØµ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºØ§Ø²Ø§Øª Ø§Ù„Ø¯ÙÙŠØ¦Ø©
 */

// 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
var panel = ui.Panel({
  style: {width: '420px', padding: '15px', border: '1px solid #ccc'}
});
ui.root.add(panel);

panel.add(ui.Label({
  value: 'Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªÙ„ÙˆØ« Ø§Ù„Ø´Ø§Ù…Ù„ - ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©',
  style: {fontSize: '20px', fontWeight: 'bold', color: '#2c3e50', textAlign: 'center'}
}));

// 2. Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
panel.add(ui.Label('1. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:', {fontWeight: 'bold'}));
var drawButton = ui.Button({
  label: 'Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© â¬ ',
  onClick: function() {
    var drawingTools = Map.drawingTools();
    drawingTools.setShown(true);
    drawingTools.setShape('polygon');
    drawingTools.draw();
  },
  style: {stretch: 'horizontal'}
});

var clearButton = ui.Button({
  label: 'Ø¥Ù„ØºØ§Ø¡ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ—‘ï¸',
  onClick: function() {
    var drawingTools = Map.drawingTools();
    while (drawingTools.layers().length() > 0) {
      drawingTools.layers().remove(drawingTools.layers().get(0));
    }
    Map.layers().reset();
    resultsPanel.clear();
  },
  style: {stretch: 'horizontal'}
});

panel.add(ui.Panel([drawButton, clearButton], ui.Panel.Layout.Flow('horizontal')));

panel.add(ui.Label('2. Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:', {fontWeight: 'bold'}));
var dateInput = ui.Textbox({value: '2025-06-01', style: {width: '100%'}});
panel.add(dateInput);

var resultsPanel = ui.Panel();

var runButton = ui.Button({
  label: 'ØªØ­Ù„ÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„Ù…Ù„ÙˆØ«Ø§Øª ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ ğŸ“Š',
  onClick: function() { 
    resultsPanel.clear();
    runGlobalAnalysis(dateInput.getValue()); 
  },
  style: {width: '100%', fontWeight: 'bold', backgroundColor: '#2ecc71', color: 'white'}
});
panel.add(runButton);
panel.add(resultsPanel);

// 3. Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„ÙˆØ«Ø§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©)
var pollutants = {
  'NO2': {id: 'COPERNICUS/S5P/OFFL/L3_NO2', band: 'tropospheric_NO2_column_number_density', limit: 0.0001, unit: 'mol/mÂ²'},
  'CO': {id: 'COPERNICUS/S5P/OFFL/L3_CO', band: 'CO_column_number_density', limit: 0.03, unit: 'mol/mÂ²'},
  'SO2': {id: 'COPERNICUS/S5P/OFFL/L3_SO2', band: 'SO2_column_number_density', limit: 0.0002, unit: 'mol/mÂ²'},
  'O3': {id: 'COPERNICUS/S5P/OFFL/L3_O3', band: 'O3_column_number_density', limit: 0.15, unit: 'mol/mÂ²'},
  'CH4': {id: 'COPERNICUS/S5P/OFFL/L3_CH4', band: 'CH4_column_volume_mixing_ratio_dry_air', limit: 1850, unit: 'ppbV'},
  'CO2': {id: 'ECMWF/CAMS/EAC4', band: 'co2_column_mean_mixing_ratio', limit: 415, unit: 'ppm'}
};

// 4. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„
function runGlobalAnalysis(dateStr) {
  var layers = Map.drawingTools().layers();
  if (layers.length() === 0) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© (Polygon) Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£ÙˆÙ„Ø§Ù‹!'); return; }
  
  resultsPanel.add(ui.Label('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©...'));
  
  var roi = layers.get(layers.length() - 1).getEeObject();
  var start = ee.Date(dateStr);
  
  // ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø£Ù†ÙŠÙ‚
  var tablePanel = ui.Panel({
    style: {border: '1px solid #eee', padding: '5px', backgroundColor: '#f9f9f9'}
  });
  
  var header = ui.Panel([
    ui.Label('Ø§Ù„Ù…Ø§Ø¯Ø©', {fontWeight: 'bold', width: '80px', color: '#555'}),
    ui.Label('Ø§Ù„Ù†ØªÙŠØ¬Ø©', {fontWeight: 'bold', width: '120px', color: '#555'}),
    ui.Label('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø¢Ù…Ù†', {fontWeight: 'bold', width: '100px', color: '#555'})
  ], ui.Panel.Layout.Flow('horizontal'));
  
  tablePanel.add(header);

  Object.keys(pollutants).forEach(function(key) {
    var p = pollutants[key];
    var col = ee.ImageCollection(p.id)
      .filterBounds(roi)
      .filterDate(start, start.advance(1, 'month'));
    
    var img = col.select(p.band).mean();
    
    var stats = img.reduceRegion({
      reducer: ee.Reducer.mean(),
      geometry: roi,
      scale: key === 'CO2' ? 10000 : 1000,
      bestEffort: true
    });

    stats.evaluate(function(result) {
      if (!result || result[p.band] === null) {
        tablePanel.add(ui.Label(key + ': Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®', {fontSize: '11px', color: 'gray'}));
        return;
      }
      
      var val = result[p.band];
      var percentage = (val / p.limit) * 100;
      
      // Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¶ÙˆØ¦ÙŠØ©)
      var statusColor = '#27ae60'; // Ø£Ø®Ø¶Ø±
      if (percentage > 90) statusColor = '#f39c12'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
      if (percentage > 110) statusColor = '#e74c3c'; // Ø£Ø­Ù…Ø±

      var row = ui.Panel([
        ui.Label(key, {width: '80px', fontWeight: 'bold'}),
        ui.Label(val.toFixed(key === 'CH4' || key === 'CO2' ? 1 : 6), {width: '120px', color: statusColor, fontWeight: 'bold'}),
        ui.Label(p.limit.toString(), {width: '100px', color: '#7f8c8d', fontSize: '12px'})
      ], ui.Panel.Layout.Flow('horizontal'), {margin: '2px 0'});
      
      tablePanel.add(row);
    });
  });

  resultsPanel.clear();
  resultsPanel.add(ui.Label('âœ… ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø«:', {fontWeight: 'bold', color: '#2c3e50'}));
  resultsPanel.add(tablePanel);
  
  // Ø¹Ø±Ø¶ NO2 ÙƒØ®Ø±ÙŠØ·Ø© Ø¨ØµØ±ÙŠØ© ÙÙˆØ±ÙŠØ©
  var visualImg = ee.ImageCollection(pollutants.NO2.id)
    .filterBounds(roi)
    .filterDate(start, start.advance(1, 'month'))
    .select(pollutants.NO2.band).mean().clip(roi);
    
  Map.layers().reset();
  Map.addLayer(visualImg, {min: 0, max: 0.0002, palette: ['#313695', '#fee090', '#d73027']}, 'ØªØ±ÙƒÙŠØ² NO2 Ø§Ù„Ø­Ø§Ù„ÙŠ');
  Map.centerObject(roi, 10);
}

// 5. Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ
var legend = ui.Panel({style: {position: 'bottom-right', padding: '10px'}});
legend.add(ui.Label('Ø¯Ù„ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ„ÙˆØ«', {fontWeight: 'bold'}));
var makeRow = function(color, name) {
  var colorBox = ui.Label({style: {backgroundColor: color, padding: '8px', margin: '0 0 4px 0', border: '0.5px solid #ccc'}});
  return ui.Panel([colorBox, ui.Label(name, {margin: '0 0 4px 6px', fontSize: '12px'})], ui.Panel.Layout.Flow('horizontal'));
};
legend.add(makeRow('#27ae60', 'Ù†Ø·Ø§Ù‚ Ø¢Ù…Ù† (Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯)'));
legend.add(makeRow('#f39c12', 'ØªØ­Ø°ÙŠØ± (ÙŠÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„Ø­Ø¯)'));
legend.add(makeRow('#e74c3c', 'Ø®Ø·Ø± (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©)'));
Map.add(legend);

// ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø©
Map.setOptions('HYBRID');